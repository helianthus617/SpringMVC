<html>
<head>
  <title>viewresolver</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/604762 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="562"/>
<h1>viewresolver</h1>

<div>
<span><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>      private void processDispatchResult(HttpServletRequest request,  HttpServletResponse response,</div><div>                  HandlerExecutionChain mappedHandler, ModelAndView mv,  Exception exception) throws Exception {</div><div>            boolean errorView = false;</div><div>            if (exception != null) {</div><div>                  if (exception instanceof  ModelAndViewDefiningException) {</div><div>                        logger.debug(&quot;ModelAndViewDefiningException  encountered&quot;, exception);</div><div>                        mv = ((ModelAndViewDefiningException)  exception).getModelAndView();</div><div>                  }</div><div>                  else {</div><div>                        Object handler = (mappedHandler != null ?  mappedHandler.getHandler() : null);</div><div>                        mv = processHandlerException(request, response,  handler, exception);</div><div>                        errorView = (mv != null);</div><div>                  }</div><div>            }</div><div>            // Did the handler return a view to render?</div><div>            if (mv != null &amp;&amp; !mv.wasCleared()) {</div><div>               <b><font color="#FF0000">   render(mv, request, response);</font></b></div><div>                  if (errorView) {</div><div>                        WebUtils.clearErrorRequestAttributes(request);</div><div>                  }</div><div>            }</div><div>            else {</div><div>                  if (logger.isDebugEnabled()) {</div><div>                        logger.debug(&quot;Null ModelAndView returned to  DispatcherServlet with name '&quot; + getServletName() +</div><div>                                    &quot;': assuming HandlerAdapter  completed request handling&quot;);</div><div>                  }</div><div>            }</div><div>            if  (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) {</div><div>                  // Concurrent handling started during a forward</div><div>                  return;</div><div>            }</div><div>            if (mappedHandler != null) {</div><div>                  mappedHandler.triggerAfterCompletion(request,  response, null);</div><div>            }</div><div>      }</div><div><br/></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div>protected void <b><font color="#FF0000">render</font></b>(ModelAndView mv, HttpServletRequest request,  HttpServletResponse response) throws Exception {</div><div>            // Determine locale for request and apply it to the  response.</div><div>//获取区域信息</div><div>         <b><font color="#FF0000">   Locale locale = this.localeResolver.resolveLocale(request);</font></b></div><div>            response.setLocale(locale);</div><div>         <b><font color="#FF0000">   View view;</font></b></div><div>            if (mv.isReference()) {</div><div>                  // We need to resolve the view name.</div><div>                                       <b><font color="#FF0000"> ../../hello </font></b>          { }</div><div>            <font color="#FF0000"><b>      view = resolveViewName(mv.getViewName(),  mv.getModelInternal(), locale, request);</b></font></div><div>org.springframework.web.servlet.view.InternalResourceView: name  '../../hello'; URL [/WEB-INF/pages/../../hello.jsp]</div><div>                  if (view == null) {</div><div>                        throw new ServletException(</div><div>                                    &quot;Could not resolve view with name '&quot;  + mv.getViewName() + &quot;' in servlet with name '&quot; +</div><div>                                                getServletName() + &quot;'&quot;);</div><div>                  }</div><div>            }</div><div>            else {</div><div>                  // No need to lookup: the ModelAndView object contains  the actual View object.</div><div>                  view = mv.getView();</div><div>                  if (view == null) {</div><div>                        throw new ServletException(&quot;ModelAndView [&quot; + mv  + &quot;] neither contains a view name nor a &quot; +</div><div>                                    &quot;View object in servlet with name '&quot;  + getServletName() + &quot;'&quot;);</div><div>                  }</div><div>            }</div><div>            // Delegate to the View object for rendering.</div><div>            if (logger.isDebugEnabled()) {</div><div>                  logger.debug(&quot;Rendering view [&quot; + view + &quot;] in  DispatcherServlet with name '&quot; + getServletName() + &quot;'&quot;);</div><div>            }</div><div>            try {</div><div>           <b><font color="#FF0000">    </font><font color="#000000">   </font></b><font color="#000000">view.render(mv.getModelInternal(), request, response);</font></div><div>            }</div><div>            catch (Exception ex) {</div><div>                  if (logger.isDebugEnabled()) {</div><div>                        logger.debug(&quot;Error rendering view [&quot; + view +  &quot;] in DispatcherServlet with name '&quot;</div><div>                                    + getServletName() + &quot;'&quot;, ex);</div><div>                  }</div><div>                  throw ex;</div><div>            }</div><div>      }</div><div><br/></div><div>      protected View <font color="#FF0000"><b>resolveViewName</b></font>(String viewName, Map&lt;String,  Object&gt; model, Locale locale,</div><div>                  HttpServletRequest request) throws Exception {</div><div><b><font color="#E30000">// this.viewResolvers ---&gt;  org.springframework.web.servlet.view.InternalResourceViewResolver</font></b></div><div>       <b><font color="#FF0000">     for (ViewResolver viewResolver : this.viewResolvers) {</font></b></div><div>                  View view = viewResolver.<b><font color="#FF0000">resolveViewName</font></b>(viewName,  locale);</div><div>                  if (view != null) {</div><div>                        return view;</div><div>                  }</div><div>            }</div><div>            return null;</div><div>      }</div><div><br/></div><div><br/></div><div><br/></div><div>public View <b><font color="#FF0000">resolveViewName</font></b>(String viewName, Locale locale) throws  Exception {</div><div>            if (!isCache()) {</div><div>                  return createView(viewName, locale);</div><div>            }</div><div>            else {</div><div>                  Object cacheKey = getCacheKey(viewName, locale);</div><div>                  View view = this.viewAccessCache.get(cacheKey);</div><div>                  if (view == null) {</div><div>                        synchronized (this.viewCreationCache) {</div><div>                              view =  this.viewCreationCache.get(cacheKey);</div><div>                              if (view == null) {</div><div>                                    // Ask the subclass to create the  View object.</div><div>                                   <b><font color="#E30000"> view = createView(viewName, locale);</font></b></div><div>                                    if (view == null &amp;&amp;  this.cacheUnresolved) {</div><div>                                          view = UNRESOLVED_VIEW;</div><div>                                    }</div><div>                                    if (view != null) {</div><div>                                          this.viewAccessCache.put(cacheKey, view);</div><div>                                          this.viewCreationCache.put(cacheKey, view);</div><div>                                          if (logger.isTraceEnabled()) {</div><div>                                                logger.trace(&quot;Cached  view [&quot; + cacheKey + &quot;]&quot;);</div><div>                                          }</div><div>                                    }</div><div>                              }</div><div>                        }</div><div>                  }</div><div>                  return (view != UNRESOLVED_VIEW ? view : null);</div><div>            }</div><div>      }</div><div><br/></div><div><br/></div><div>      @Override</div><div>      protected View <b><font color="#FF0000">createView</font></b>(String viewName, Locale locale) throws  Exception {</div><div>            // If this resolver is not supposed to handle the given  view,</div><div>            // return null to pass on to the next resolver in the chain.</div><div>            if (!canHandle(viewName, locale)) {</div><div>                  return null;</div><div>            }</div><div>            // Check for special &quot;<b><font color="#FF0000">redirect</font></b>:&quot; prefix.</div><div>            if (viewName.startsWith(REDIRECT_URL_PREFIX)) {</div><div>                  String redirectUrl =  viewName.substring(REDIRECT_URL_PREFIX.length());</div><div>                  <b><font color="#E30000">RedirectView view = new RedirectView(redirectUrl,  isRedirectContextRelative(), isRedirectHttp10Compatible());</font></b></div><div>                  return applyLifecycleMethods(viewName, view);</div><div>            }</div><div>            // Check for special &quot;<font color="#FF0000"><b>forward</b></font>:&quot; prefix.</div><div>            if (viewName.startsWith(FORWARD_URL_PREFIX)) {</div><div>                  String forwardUrl =  viewName.substring(FORWARD_URL_PREFIX.length());</div><div>                <font color="#FF0000"><b>  return new InternalResourceView(forwardUrl);</b></font></div><div>            }</div><div>            // Else fall back to superclass implementation: calling  loadView.</div><div>           <b><font color="#FF0000"> return super.createView(viewName, locale);</font></b></div><div>      }</div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>protected void render(ModelAndView mv, HttpServletRequest request,  HttpServletResponse response) throws Exception {</div><div>            // Determine locale for request and apply it to the  response.</div><div>            Locale locale = this.localeResolver.resolveLocale(request);</div><div>            response.setLocale(locale);</div><div>            View view;</div><div>            if (mv.isReference()) {</div><div>                  // We need to resolve the view name.</div><div>                                        ../../hello           { }</div><div>               <font color="#FF0000"><b>   view = resolveViewName(mv.getViewName(),  mv.getModelInternal(), locale, request);</b></font></div><div>org.springframework.web.servlet.view.InternalResourceView: name  '../../hello'; URL [/WEB-INF/pages/../../hello.jsp]</div><div>                  if (view == null) {</div><div>                        throw new ServletException(</div><div>                                    &quot;Could not resolve view with name '&quot;  + mv.getViewName() + &quot;' in servlet with name '&quot; +</div><div>                                                getServletName() + &quot;'&quot;);</div><div>                  }</div><div>            }</div><div>            else {</div><div>                  // No need to lookup: the ModelAndView object contains  the actual View object.</div><div>                  view = mv.getView();</div><div>                  if (view == null) {</div><div>                        throw new ServletException(&quot;ModelAndView [&quot; + mv  + &quot;] neither contains a view name nor a &quot; +</div><div>                                    &quot;View object in servlet with name '&quot;  + getServletName() + &quot;'&quot;);</div><div>                  }</div><div>            }</div><div>            // Delegate to the View object for rendering.</div><div>            if (logger.isDebugEnabled()) {</div><div>                  logger.debug(&quot;Rendering view [&quot; + view + &quot;] in  DispatcherServlet with name '&quot; + getServletName() + &quot;'&quot;);</div><div>            }</div><div>            try {</div><div>              <font color="#FF0000"><b>    view.render(mv.getModelInternal(), request, response);</b></font></div><div>            }</div><div>            catch (Exception ex) {</div><div>                  if (logger.isDebugEnabled()) {</div><div>                        logger.debug(&quot;Error rendering view [&quot; + view +  &quot;] in DispatcherServlet with name '&quot;</div><div>                                    + getServletName() + &quot;'&quot;, ex);</div><div>                  }</div><div>                  throw ex;</div><div>            }</div><div>      }</div><div><br/></div><div><br/></div><div><br/></div><div>@Override</div><div>      public void render(<b><font color="#E30000">Map&lt;String, ?&gt; model,</font></b> HttpServletRequest  request, HttpServletResponse response) throws Exception {</div><div>            if (logger.isTraceEnabled()) {</div><div>                  logger.trace(&quot;Rendering view with name '&quot; +  this.beanName + &quot;' with model &quot; + model +</div><div>                        &quot; and static attributes &quot; +  this.staticAttributes);</div><div>            }</div><div>          <b><font color="#FF4635">  Map&lt;String, Object&gt; mergedModel =  createMergedOutputModel(model, request, response);</font></b></div><div>            prepareResponse(request, response);</div><div>//准备渲染数据</div><div>           <b><font color="#FF0000"> renderMergedOutputModel(mergedModel, request, response);</font></b></div><div>      }</div><div><br/></div><div><br/></div><div><br/></div><div>      protected void <b><font color="#E30000">renderMergedOutputModel</font></b>(</div><div>                  Map&lt;String, Object&gt; model, HttpServletRequest request,  HttpServletResponse response) throws Exception {</div><div>            // Determine which request handle to expose to the  RequestDispatcher.</div><div>            HttpServletRequest requestToExpose =  getRequestToExpose(request);</div><div>            // Expose the model object as request attributes.</div><div>//将模型中的数据放到请求域中</div><div>          <b><font color="#FF4635">  exposeModelAsRequestAttributes(model, requestToExpose);</font></b></div><div>            // Expose helpers as request attributes, if any.</div><div>            exposeHelpers(requestToExpose);</div><div>            // Determine the path for the request dispatcher.</div><div>          <b><font color="#E30000">  String dispatcherPath = prepareForRendering(requestToExpose,  response);</font></b></div><div>            // Obtain a RequestDispatcher for the target resource  (typically a JSP).</div><div>           <b><font color="#E30000"> RequestDispatcher rd = getRequestDispatcher(requestToExpose,  dispatcherPath);</font></b></div><div>            if (rd == null) {</div><div>                  throw new ServletException(&quot;Could not get  RequestDispatcher for [&quot; + getUrl() +</div><div>                              &quot;]: Check that the corresponding file  exists within your web application archive!&quot;);</div><div>            }</div><div>            // If already included or response already committed,  perform include, else forward.</div><div>            if (useInclude(requestToExpose, response)) {</div><div>                  response.setContentType(getContentType());</div><div>                  if (logger.isDebugEnabled()) {</div><div>                        logger.debug(&quot;Including resource [&quot; + getUrl() +  &quot;] in InternalResourceView '&quot; + getBeanName() + &quot;'&quot;);</div><div>                  }</div><div>                  rd.include(requestToExpose, response);</div><div>            }</div><div>            else {</div><div>                  // Note: The forwarded resource is supposed to  determine the content type itself.</div><div>                  if (logger.isDebugEnabled()) {</div><div>                        logger.debug(&quot;Forwarding to resource [&quot; +  getUrl() + &quot;] in InternalResourceView '&quot; + getBeanName() + &quot;'&quot;);</div><div>                  }</div><div>                <b><font color="#FF0000">  rd.forward(requestToExpose, response);</font></b></div><div>            }</div><div>      }</div><div><br/></div><div><br/></div><div><br/></div><div>protected void <font color="#E30000"><b>exposeModelAsRequestAttributes</b></font>(Map&lt;String, Object&gt; model,  HttpServletRequest request) throws Exception {</div><div>            for (Map.Entry&lt;String, Object&gt; entry : model.entrySet()) {</div><div>                  String modelName = entry.getKey();</div><div>                  Object modelValue = entry.getValue();</div><div>                  if (modelValue != null) {</div><div>                <b><font color="#FF0000">        request.setAttribute(modelName, modelValue);</font></b></div><div>                        if (logger.isDebugEnabled()) {</div><div>                              logger.debug(&quot;Added model object '&quot; +  modelName + &quot;' of type [&quot; + modelValue.getClass().getName() +</div><div>                                          &quot;] to request in view with  name '&quot; + getBeanName() + &quot;'&quot;);</div><div>                        }</div><div>                  }</div><div>                  else {</div><div>                        request.removeAttribute(modelName);</div><div>                        if (logger.isDebugEnabled()) {</div><div>                              logger.debug(&quot;Removed model object '&quot; +  modelName +</div><div>                                          &quot;' from request in view with  name '&quot; + getBeanName() + &quot;'&quot;);</div><div>                        }</div><div>                  }</div><div>            }</div><div>      }</div><div><br/></div><div>视图解析器只是为了得到视图,视图对象才能真正的转发(将模型数据全部放到请求域中)重定向到页面</div><div><b><font color="#FF0000">internalResourceView</font></b></div><div><b><font color="#FF0000">JstlView 如果jsp页面使用了JSTL国际化标签,则需要这个视图对象</font></b></div><div><span style="font-size: 9pt; color: rgb(255, 0, 0); font-family: Monaco;"><b>InternalResourceViewResolver  将视图名解析为一个URL文件,</b></span></div><div><span style="font-size: 9pt; color: rgb(255, 0, 0); font-family: Monaco;"><b>一般使用该解析器将视图名映射为一个保存在WEB-INF目录下的程序文件(JSP）</b></span></div></div><div><br/></div></span>
</div></body></html> 